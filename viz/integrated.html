<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CLIDE // UNIFIED INTELLIGENCE PORTAL v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/force-graph"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;700&display=swap');
        
        :root {
            --neon-red: #ff003c;
            --neon-cyan: #00f3ff;
            --neon-green: #00ff88;
            --neon-purple: #bc00ff;
            --bg-black: #050505;
            --card-gray: #111111;
        }

        body {
            background-color: var(--bg-black);
            color: #e0e0e0;
            font-family: 'JetBrains Mono', monospace;
            overflow: hidden;
            touch-action: manipulation;
        }

        .cyber-border {
            border: 1px solid rgba(0, 243, 255, 0.2);
            position: relative;
        }

        .cyber-border::before {
            content: '';
            position: absolute;
            top: -1px; left: -1px; width: 10px; height: 10px;
            border-top: 2px solid var(--neon-cyan);
            border-left: 2px solid var(--neon-cyan);
        }

        .cyber-panel {
            background: rgba(17, 17, 17, 0.9);
            backdrop-filter: blur(15px);
        }

        .scrollbar-hide::-webkit-scrollbar { display: none; }
        
        /* Atlas Typography */
        #doc-content h1 { color: var(--neon-cyan); font-size: 1.5rem; font-weight: 700; margin-bottom: 1.2rem; border-bottom: 1px solid rgba(0, 243, 255, 0.2); padding-bottom: 0.5rem; }
        #doc-content h2 { color: var(--neon-purple); font-size: 1.25rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.8rem; }
        #doc-content p { line-height: 1.6; margin-bottom: 0.8rem; color: #ccc; font-size: 0.9rem; }
        #doc-content table { width: 100%; overflow-x: auto; display: block; margin: 1rem 0; }
        #doc-content th { background: rgba(0, 243, 255, 0.1); color: var(--neon-cyan); padding: 0.5rem; font-size: 0.65rem; }
        #doc-content td { padding: 0.5rem; border: 1px solid rgba(255,255,255,0.1); font-size: 0.75rem; }

        .stream-row:hover { background: rgba(255, 255, 255, 0.05); border-left: 2px solid var(--neon-cyan); }

        /* Responsive Layout */
        .sidebar { width: 280px; flex-shrink: 0; display: none; }
        @media (min-width: 1024px) { .sidebar { display: flex; } }
        
        .main-content { flex-grow: 1; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Mobile Bottom Nav */
        .mobile-nav { 
            position: fixed; bottom: 0; left: 0; right: 0; height: 64px; 
            background: rgba(10,10,10,0.95); border-top: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-around; align-items: center; z-index: 100;
        }
        @media (min-width: 1024px) { .mobile-nav { display: none; } }

        /* Node Inspector Sheet */
        #node-info {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @media (max-width: 1023px) {
            #node-info {
                position: fixed; bottom: 0; left: 0; right: 0; top: auto;
                width: 100% !important; max-height: 70vh; transform: translateY(100%);
                border-radius: 20px 20px 0 0; z-index: 150;
            }
            #node-info.active { transform: translateY(0); }
        }
    </style>
</head>
<body class="h-screen flex flex-col pb-[64px] lg:pb-0">

    <!-- HEADER (Simplified for Mobile) -->
    <header class="h-14 border-b border-white/10 flex items-center justify-between px-4 lg:px-6 bg-black/50 z-50">
        <div class="flex items-center space-x-3">
            <span class="text-xl lg:text-2xl font-bold tracking-tighter text-red-500">CLIDE</span>
            <div id="monitor-pulse" class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
        </div>
        
        <div class="hidden md:flex space-x-8 text-[11px] font-bold uppercase tracking-widest">
            <div class="flex items-center space-x-4">
                <span class="text-white/40">CPU <span id="cpu-val" class="text-cyan-400 ml-1">0%</span></span>
                <span class="text-white/40">MEM <span id="mem-val" class="text-purple-400 ml-1">0%</span></span>
            </div>
        </div>

        <div class="flex items-center space-x-4">
            <span id="clock" class="text-[10px] lg:text-xs font-mono text-cyan-400">00:00:00</span>
            <button onclick="toggleSidebar()" class="lg:hidden p-3 mr-2 text-cyan-400 hover:text-white border border-white/10 rounded bg-white/5">
                <span class="text-[10px] font-bold mr-2">MENU</span>
                <svg class="w-5 h-5 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </div>
    </header>

    <div class="flex-grow flex overflow-hidden relative">
        
        <!-- SIDEBAR (Collapsible on Mobile) -->
        <aside id="main-sidebar" class="sidebar border-r border-white/10 flex flex-col bg-black/95 absolute inset-y-0 left-0 z-[110] lg:relative lg:bg-black/30 lg:translate-x-0 transition-transform duration-300 -translate-x-full w-[300px]">
            <nav class="p-6 space-y-8 flex-grow overflow-y-auto">
                <div class="lg:hidden flex justify-between items-center mb-6">
                    <span class="text-xs font-bold text-white/30 uppercase">Navigator</span>
                    <button onclick="toggleSidebar()" class="text-white/20 p-2 border border-white/10 rounded">✕ CLOSE</button>
                </div>
                
                <div class="hidden lg:block">
                    <h3 class="text-[10px] text-white/30 mb-4 tracking-widest uppercase font-bold border-b border-white/5 pb-2">Intelligence Hub</h3>
                    <ul class="space-y-2">
                        <li><button onclick="showModule('dashboard')" id="btn-dashboard" class="w-full text-left px-4 py-3 text-xs hover:bg-white/5 rounded-lg border border-transparent transition-all flex items-center space-x-3"><span class="text-cyan-500 text-lg">◈</span> <span>Dashboard</span></button></li>
                        <li><button onclick="showModule('navigator')" id="btn-navigator" class="w-full text-left px-4 py-3 text-xs hover:bg-white/5 rounded-lg border border-transparent transition-all flex items-center space-x-3"><span class="text-purple-500 text-lg">◈</span> <span>Neural Map</span></button></li>
                        <li><button onclick="showModule('atlas')" id="btn-atlas" class="w-full text-left px-4 py-3 text-xs hover:bg-white/5 rounded-lg border border-transparent transition-all flex items-center space-x-3"><span class="text-green-500 text-lg">◈</span> <span>Command Atlas</span></button></li>
                        <li><button onclick="showModule('config')" id="btn-config" class="w-full text-left px-4 py-3 text-xs hover:bg-white/5 rounded-lg border border-transparent transition-all flex items-center space-x-3"><span class="text-red-500 text-lg">◈</span> <span>Kernel Config</span></button></li>
                    </ul>
                </div>

                <div class="flex-grow">
                    <h3 class="text-[10px] text-white/30 mb-4 tracking-widest uppercase font-bold border-b border-white/5 pb-2">Active Domains</h3>
                    <div id="doc-list" class="space-y-1 pr-2"></div>
                </div>
            </nav>

            <div class="p-6 border-t border-white/10">
                <div class="p-4 bg-white/5 rounded-xl cyber-border">
                    <div class="text-[9px] text-white/40 mb-1 uppercase">Neural Registry</div>
                    <div id="node-count" class="text-3xl font-bold text-cyan-400">0</div>
                </div>
            </div>
        </aside>

        <!-- MAIN STAGE -->
        <main class="main-content relative bg-gradient-to-br from-black to-[#0a0a0a]">
            
            <!-- MODULE: DASHBOARD -->
            <div id="module-dashboard" class="module p-4 lg:p-8 grid grid-cols-12 gap-4 lg:gap-6 overflow-y-auto h-full scrollbar-hide pb-20 lg:pb-8">
                
                <!-- MOBILE CARDS -->
                <div class="col-span-12 grid grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="cyber-panel cyber-border p-4">
                        <div class="text-[8px] text-white/30 uppercase mb-1">Semantic Parity</div>
                        <div class="text-xl lg:text-2xl font-bold text-cyan-400">98.2%</div>
                    </div>
                    <div class="cyber-panel cyber-border p-4">
                        <div class="text-[8px] text-white/30 uppercase mb-1">Active Tasks</div>
                        <div id="dash-todo-count" class="text-xl lg:text-2xl font-bold text-yellow-400">0</div>
                    </div>
                    <div class="cyber-panel cyber-border p-4">
                        <div class="text-[8px] text-white/30 uppercase mb-1">Entropy</div>
                        <div class="text-xl lg:text-2xl font-bold text-purple-400">1.24</div>
                    </div>
                    <div class="cyber-panel cyber-border p-4">
                        <div class="text-[8px] text-white/30 uppercase mb-1">Uptime</div>
                        <div id="uptime-val" class="text-xl font-bold text-green-400 truncate">00:00:00</div>
                    </div>
                </div>

                <!-- MAIN CHARTS -->
                <div class="col-span-12 lg:col-span-8 cyber-panel cyber-border p-4 lg:p-8 h-[300px] lg:h-[400px] flex flex-col">
                    <h3 class="text-cyan-400 font-bold uppercase tracking-widest text-[9px] mb-4">System Telemetry</h3>
                    <div class="flex-grow min-h-0"><canvas id="load-chart"></canvas></div>
                </div>

                <!-- STRATEGY -->
                <div class="col-span-12 lg:col-span-4 cyber-panel cyber-border p-4 lg:p-8 flex flex-col min-h-[300px]">
                    <h3 class="text-yellow-400 mb-4 font-bold uppercase tracking-widest text-[9px]">Priority Strategy</h3>
                    <div id="dash-strategy" class="space-y-3 flex-grow overflow-y-auto"></div>
                </div>

                <!-- DISTRIBUTION -->
                <div class="col-span-12 cyber-panel cyber-border p-4 lg:p-8">
                    <h3 class="text-white/60 mb-6 font-bold uppercase tracking-widest text-[9px]">Neural Sector Map</h3>
                    <div id="sector-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 lg:gap-8"></div>
                </div>
            </div>

            <!-- MODULE: NAVIGATOR -->
            <div id="module-navigator" class="module hidden h-full w-full relative">
                <div id="graph-container" class="h-full w-full flex items-center justify-center text-white/30 text-xs uppercase tracking-widest">
                    INITIALIZING SENSOR ARRAY...
                </div>
                
                <!-- MOBILE FILTERS (Icon only or collapsible) -->
                <div class="absolute top-4 left-4 flex flex-col space-y-2">
                    <button onclick="toggleFilters()" class="p-2 bg-black/80 border border-white/10 rounded-lg text-cyan-400 shadow-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
                    </button>
                </div>

                <div id="filter-panel" class="absolute top-16 left-4 p-4 cyber-panel cyber-border w-56 hidden lg:block">
                    <div id="category-toggles" class="space-y-2"></div>
                </div>

                <!-- NODE INSPECTOR (Mobile Sheet / Desktop Panel) -->
                <div id="node-info" class="absolute top-6 right-6 w-full lg:w-96 cyber-panel lg:cyber-border p-6 lg:p-8 hidden flex flex-col">
                    <!-- Handle for mobile -->
                    <div class="lg:hidden w-12 h-1.5 bg-white/10 rounded-full mx-auto mb-6"></div>
                    
                    <div class="flex justify-between items-start mb-4">
                        <div id="info-id" class="text-[9px] text-white/30 font-mono">NODE #0000</div>
                        <button onclick="closeInspector()" class="text-white/20 p-2">✕</button>
                    </div>
                    <h4 id="info-name" class="text-xl lg:text-2xl font-bold text-cyan-400 mb-2 truncate"></h4>
                    <div id="info-cat" class="inline-block px-2 py-0.5 rounded text-[9px] font-bold uppercase mb-4 w-fit">FACT</div>
                    <div class="flex-grow overflow-y-auto pr-2 scrollbar-hide text-xs lg:text-sm text-white/70 leading-relaxed italic border-l border-white/10 pl-4 mb-6">
                        <div id="info-desc"></div>
                    </div>
                    <div id="info-imp" class="text-lg font-bold text-green-400"></div>
                </div>
            </div>

            <!-- MODULE: ATLAS -->
            <div id="module-atlas" class="module hidden h-full flex flex-col bg-black">
                <div class="h-14 border-b border-white/5 px-4 lg:px-8 flex items-center justify-between bg-white/2">
                    <div id="atlas-breadcrumbs" class="text-[9px] font-mono tracking-widest text-white/40 uppercase truncate">SYSTEM // ATLAS</div>
                </div>
                <div class="flex-grow overflow-y-auto p-6 lg:p-12 scrollbar-hide pb-24 lg:pb-12">
                    <div id="doc-content" class="max-w-4xl mx-auto"></div>
                </div>
            </div>

            <!-- MODULE: CONFIG -->
            <div id="module-config" class="module hidden h-full p-6 lg:p-12 overflow-y-auto pb-24">
                <div class="max-w-4xl mx-auto space-y-8">
                    <div class="flex justify-between items-center">
                        <h2 class="text-2xl lg:text-4xl font-bold text-red-500 tracking-tighter">Kernel Config</h2>
                        <button onclick="saveConfig()" class="bg-red-500 hover:bg-red-600 text-black font-bold px-6 py-2 rounded text-xs uppercase tracking-widest transition-colors">Save Changes</button>
                    </div>
                    <div class="relative">
                        <textarea id="config-json-edit" class="w-full h-96 bg-white/5 rounded-xl cyber-border font-mono text-[10px] text-cyan-400/80 p-4 lg:p-8 outline-none focus:border-cyan-400/50 resize-y"></textarea>
                        <div id="config-status" class="absolute top-2 right-2 text-[9px] font-bold text-green-400 hidden">SAVED</div>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-8">
                        <div class="p-6 cyber-panel cyber-border"><h4 class="text-[9px] font-bold text-white/60 uppercase mb-4">Core Pathing</h4><div id="config-paths" class="space-y-3"></div></div>
                        <div class="p-6 cyber-panel cyber-border"><h4 class="text-[9px] font-bold text-white/60 uppercase mb-4">Extraction</h4><div id="config-extract" class="space-y-3"></div></div>
                    </div>
                </div>
            </div>

            <!-- MOBILE NAV BAR -->
            <nav class="mobile-nav px-4">
                <button onclick="showModule('dashboard')" class="flex flex-col items-center space-y-1 text-white/40" id="mbtn-dashboard"><div class="w-5 h-5 bg-cyan-500/20 flex items-center justify-center rounded">◈</div><span class="text-[8px] font-bold uppercase">Dash</span></button>
                <button onclick="showModule('navigator')" class="flex flex-col items-center space-y-1 text-white/40" id="mbtn-navigator"><div class="w-5 h-5 bg-purple-500/20 flex items-center justify-center rounded">◈</div><span class="text-[8px] font-bold uppercase">Map</span></button>
                <button onclick="showModule('atlas')" class="flex flex-col items-center space-y-1 text-white/40" id="mbtn-atlas"><div class="w-5 h-5 bg-green-500/20 flex items-center justify-center rounded">◈</div><span class="text-[8px] font-bold uppercase">Atlas</span></button>
                <button onclick="showModule('config')" class="flex flex-col items-center space-y-1 text-white/40" id="mbtn-config"><div class="w-5 h-5 bg-red-500/20 flex items-center justify-center rounded">◈</div><span class="text-[8px] font-bold uppercase">Sys</span></button>
            </nav>

        </main>
    </div>

    <script>
        const COLORS = { 'FACT': '#00ff88', 'TODO': '#ffcc00', 'NEW_COMMAND': '#00aaff', 'TOOL_INTENT': '#bc00ff', 'SHELL_HISTORY': '#555555', 'PROPOSAL': '#ff003c' };
        let currentModule = 'dashboard', graph, chart, visibleCategories = new Set(['FACT', 'TODO', 'NEW_COMMAND', 'TOOL_INTENT', 'SHELL_HISTORY', 'PROPOSAL']), allNodes = [], allLinks = [];
        let currentConfig = {};

        function toggleSidebar() {
            const sb = document.getElementById('main-sidebar');
            sb.classList.toggle('-translate-x-full');
        }

        function toggleFilters() {
            const fp = document.getElementById('filter-panel');
            fp.classList.toggle('hidden');
        }

        function showModule(mod) {
            document.querySelectorAll('.module').forEach(m => m.classList.add('hidden'));
            document.querySelectorAll('aside button, .mobile-nav button').forEach(b => b.classList.remove('text-cyan-400', 'bg-white/10'));
            
            document.getElementById(`module-${mod}`).classList.remove('hidden');
            const btn = document.getElementById(`btn-${mod}`);
            if (btn) btn.classList.add('bg-white/10', 'text-cyan-400');
            
            const mbtn = document.getElementById(`mbtn-${mod}`);
            if (mbtn) mbtn.classList.add('text-cyan-400');

            currentModule = mod;
            if (mod === 'navigator' && !graph) initGraph();
            if (mod === 'dashboard' && !chart) initChart();
            if (mod === 'config') fetchConfig();
            
            // Auto-close sidebar on mobile after selection
            if (window.innerWidth < 1024) document.getElementById('main-sidebar').classList.add('-translate-x-full');
        }

        function initChart() {
            const ctx = document.getElementById('load-chart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: { labels: Array(30).fill(''), datasets: [
                    { label: 'CPU', borderColor: '#00f3ff', backgroundColor: 'rgba(0, 243, 255, 0.1)', data: Array(30).fill(0), fill: true, tension: 0.4, borderWidth: 2, pointRadius: 0 },
                    { label: 'MEM', borderColor: '#bc00ff', backgroundColor: 'rgba(188, 0, 255, 0.1)', data: Array(30).fill(0), fill: true, tension: 0.4, borderWidth: 2, pointRadius: 0 }
                ]},
                options: { responsive: true, maintainAspectRatio: false, scales: { 
                    y: { min: 0, max: 100, grid: { display: false }, ticks: { display: false } },
                    x: { grid: { display: false }, ticks: { display: false } }
                }, plugins: { legend: { display: false } } }
            });
        }

        async function fetchStats() {
            const res = await fetch('/api/stats');
            const data = await res.json();
            document.getElementById('cpu-val').innerText = `${Math.round(data.system.cpu)}%`;
            document.getElementById('mem-val').innerText = `${Math.round(data.system.mem)}%`;
            document.getElementById('node-count').innerText = data.neural.total_assets || 0;
            const h = Math.floor(data.system.uptime / 3600), m = Math.floor((data.system.uptime % 3600) / 60), s = data.system.uptime % 60;
            document.getElementById('uptime-val').innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
            if (chart && data.system.history) {
                chart.data.datasets[0].data = data.system.history.cpu.map(p => p.value).slice(-30);
                chart.data.datasets[1].data = data.system.history.mem.map(p => p.value).slice(-30);
                chart.update('none');
            }
            if (currentModule === 'dashboard') updateDashboardDistribution(data.neural.distribution);
        }

        function updateDashboardDistribution(dist) {
            const grid = document.getElementById('sector-grid');
            if (!dist) return;
            grid.innerHTML = Object.entries(dist).map(([cat, count]) => `
                <div class="space-y-2">
                    <div class="flex justify-between items-end text-[8px] font-bold">
                        <span class="text-white/40 uppercase">${cat}</span>
                        <span class="text-white">${count}</span>
                    </div>
                    <div class="w-full h-1 bg-white/5 rounded-full overflow-hidden">
                        <div class="h-full" style="width: ${Math.min(100, count/2)}%; background-color: ${COLORS[cat] || '#00f3ff'}"></div>
                    </div>
                </div>
            `).join('');
        }

        async function fetchDocs() {
            const res = await fetch('/api/docs');
            const docs = await res.json();
            const list = document.getElementById('doc-list');
            
            // Group by domain
            const groups = {};
            docs.forEach(doc => {
                if (!groups[doc.domain]) groups[doc.domain] = [];
                // FILTER: Don't show index files in the list (handled by domain click)
                if (doc.name.toLowerCase() !== 'index') groups[doc.domain].push(doc);
            });

            list.innerHTML = Object.entries(groups).map(([domain, items]) => `
                <div class="mb-4">
                    <div class="w-full flex items-center justify-between group py-1">
                        <button onclick="loadDomain('${domain}')" class="text-[10px] font-bold text-cyan-400 uppercase tracking-widest hover:text-white transition-colors flex items-center space-x-2">
                            <span>${domain}</span>
                            <span class="text-[8px] text-white/30 bg-white/5 px-1 rounded">IDX</span>
                        </button>
                        <button onclick="toggleDomain('${domain}')" class="p-1 hover:bg-white/5 rounded">
                            <svg id="icon-${domain}" class="w-3 h-3 text-white/20 transition-transform rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                        </button>
                    </div>
                    <div id="group-${domain}" class="mt-2 space-y-1 pl-2 border-l border-white/5">
                        ${items.length === 0 ? '<div class="text-[8px] text-white/20 italic px-3">No sub-documents</div>' : ''}
                        ${items.map(doc => `
                            <button onclick="loadDoc('${doc.path}', '${doc.domain}', '${doc.name}')" class="w-full text-left px-3 py-1.5 text-[10px] text-white/40 hover:text-white hover:bg-white/5 rounded transition-all truncate">
                                ${doc.name.toUpperCase()}
                            </button>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function toggleDomain(domain) {
            const el = document.getElementById(`group-${domain}`);
            const icon = document.getElementById(`icon-${domain}`);
            el.classList.toggle('hidden');
            icon.classList.toggle('rotate-90');
        }

        async function loadDoc(path, domain, name) {
            showModule('atlas');
            document.getElementById('atlas-breadcrumbs').innerText = `${domain.toUpperCase()} // ${name.toUpperCase()}`;
            const res = await fetch(`/api/docs/${path}`);
            const text = await res.text();
            
            // Render Markdown
            document.getElementById('doc-content').innerHTML = marked.parse(text);
            
            // Syntax Highlighting
            Prism.highlightAllUnder(document.getElementById('doc-content'));
            
            // Mermaid Rendering
            try {
                mermaid.init(undefined, ".mermaid");
            } catch (e) {
                console.error("Mermaid render failed:", e);
            }
        }

        async function loadDomain(domain) {
            // Load the index page for this domain
            const path = `${domain}/index.md`;
            loadDoc(path, domain, 'INDEX');
        }

        async function fetchStream() {
            try {
                const res = await fetch('/api/stream?limit=15');
                const data = await res.json();
                const strat = document.getElementById('dash-strategy');
                if (strat) {
                    const todos = data.filter(l => l.category === 'TODO').slice(0, 5);
                    document.getElementById('dash-todo-count').innerText = todos.length;
                    
                    if (todos.length === 0) {
                        strat.innerHTML = `
                            <div class="h-full flex flex-col items-center justify-center text-center opacity-40">
                                <div class="text-4xl text-green-500 mb-2">✓</div>
                                <div class="text-[9px] uppercase tracking-widest text-green-400">System Parity Achieved</div>
                                <div class="text-[8px] text-white/50 mt-1">No pending strategies detected</div>
                            </div>
                        `;
                    } else {
                        strat.innerHTML = todos.map(t => `
                            <div class="p-3 bg-white/5 rounded border border-white/5 hover:border-cyan-400/30 transition-colors cursor-default">
                                <div class="flex justify-between items-start mb-1">
                                    <span class="text-[8px] font-bold text-yellow-500 bg-yellow-500/10 px-1 rounded">PRIORITY</span>
                                    <span class="text-[8px] text-white/30 font-mono">${new Date(t.timestamp * 1000).toLocaleTimeString()}</span>
                                </div>
                                <p class="text-[10px] text-white/80 leading-relaxed">${t.content}</p>
                            </div>
                        `).join('');
                    }
                }
            } catch (e) { console.error(e); }
        }

        function initGraph() {
            const container = document.getElementById('graph-container');
            fetch('/api/nodes').then(r => r.json()).then(data => {
                if (!data.nodes || data.nodes.length === 0) {
                    container.innerHTML = `<div class="text-center"><div class="text-red-500 text-4xl mb-4">⚠</div><div class="text-xs text-red-400 tracking-widest uppercase">No Neural Data Detected</div><div class="text-[9px] text-white/30 mt-2">Run ingestion cycle to populate registry</div></div>`;
                    return;
                }
                
                allNodes = data.nodes; allLinks = data.links;
                const cats = [...new Set(allNodes.map(n => n.group))];
                document.getElementById('category-toggles').innerHTML = cats.map(cat => `
                    <label class="flex items-center justify-between cursor-pointer"><div class="flex items-center space-x-2"><div class="w-1.5 h-1.5 rounded-full" style="background: ${COLORS[cat] || '#00f3ff'}"></div><span class="text-[9px] text-white/50 uppercase">${cat}</span></div><input type="checkbox" checked onchange="toggleCategory('${cat}')" class="w-2.5 h-2.5 accent-cyan-500"></label>
                `).join('');
                
                graph = ForceGraph()(container)
                    .width(container.offsetWidth)
                    .height(container.offsetHeight)
                    .graphData(data).nodeColor(node => COLORS[node.group] || '#00f3ff')
                    .nodeRelSize(node => node.val ? Math.max(3, node.val) : 5)
                    .linkColor(() => 'rgba(255,255,255,0.05)').linkWidth(0.5)
                    .onNodeClick(node => inspectNode(node))
                    .backgroundColor('rgba(0,0,0,0)');

                // Handle resize
                window.addEventListener('resize', () => {
                    if (currentModule === 'navigator' && graph) {
                        graph.width(container.offsetWidth);
                        graph.height(container.offsetHeight);
                    }
                });
            });
        }

        function toggleCategory(cat) {
            if (visibleCategories.has(cat)) visibleCategories.delete(cat); else visibleCategories.add(cat);
            const filteredNodes = allNodes.filter(n => visibleCategories.has(n.group));
            const nodeIds = new Set(filteredNodes.map(n => n.id));
            const filteredLinks = allLinks.filter(l => nodeIds.has(l.source.id || l.source) && nodeIds.has(l.target.id || l.target));
            graph.graphData({ nodes: filteredNodes, links: filteredLinks });
        }

        function inspectNode(node) {
            const info = document.getElementById('node-info');
            info.classList.remove('hidden');
            setTimeout(() => info.classList.add('active'), 10);
            document.getElementById('info-id').innerText = `NODE #${node.id}`;
            document.getElementById('info-name').innerText = node.name;
            const ic = document.getElementById('info-cat');
            ic.innerText = node.group; ic.style.color = COLORS[node.group]; ic.style.background = `${COLORS[node.group]}22`;
            document.getElementById('info-desc').innerText = node.desc;
            document.getElementById('info-imp').innerText = `Priority: ${node.val}/10`;
        }

        function closeInspector() {
            const info = document.getElementById('node-info');
            info.classList.remove('active');
            setTimeout(() => info.classList.add('hidden'), 300);
        }

        async function fetchConfig() {
            const res = await fetch('/api/config');
            const data = await res.json();
            currentConfig = data;
            document.getElementById('config-json-edit').value = JSON.stringify(data, null, 4);
            document.getElementById('config-paths').innerHTML = Object.entries(data.paths || {}).map(([k, v]) => `<div class="flex justify-between border-b border-white/5 pb-1"><span class="text-[8px] text-white/30 uppercase">${k}</span><span class="text-[8px] text-cyan-400 font-mono">${v}</span></div>`).join('');
            document.getElementById('config-extract').innerHTML = Object.entries(data.extraction || {}).map(([k, v]) => `<div class="flex justify-between border-b border-white/5 pb-1"><span class="text-[8px] text-white/30 uppercase">${k}</span><span class="text-[8px] text-purple-400 font-mono">${v}</span></div>`).join('');
        }

        async function saveConfig() {
            const btn = document.querySelector('button[onclick="saveConfig()"]');
            const txt = document.getElementById('config-json-edit').value;
            const status = document.getElementById('config-status');
            
            try {
                const json = JSON.parse(txt);
                btn.innerText = "SAVING...";
                const res = await fetch('/api/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(json)
                });
                
                if (res.ok) {
                    btn.innerText = "SAVED";
                    status.classList.remove('hidden');
                    setTimeout(() => { 
                        btn.innerText = "SAVE CHANGES"; 
                        status.classList.add('hidden');
                    }, 2000);
                    fetchConfig(); // Refresh view
                } else {
                    alert("Error saving config");
                    btn.innerText = "RETRY";
                }
            } catch (e) {
                alert("Invalid JSON format");
            }
        }

        setInterval(() => { document.getElementById('clock').innerText = new Date().toLocaleTimeString(); }, 1000);
        showModule('dashboard'); fetchDocs();
        setInterval(fetchStats, 2000); setInterval(fetchStream, 3000);
        fetchStats(); fetchStream();
        mermaid.initialize({ startOnLoad: false, theme: 'dark', securityLevel: 'loose' });
    </script>
</body>
</html>
